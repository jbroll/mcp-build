#!/bin/bash
#
# MCP Build Service - Startup Script
#
# This script ensures the service is properly set up and starts it with
# all provided command line arguments.
#

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored messages
print_error() {
    echo -e "${RED}ERROR: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}WARNING: $1${NC}"
}

# Check if Python 3 is available
if ! command -v python3 &> /dev/null; then
    print_error "Python 3 is not installed. Please install Python 3.10 or higher."
    exit 1
fi

# Check Python version
PYTHON_VERSION=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
REQUIRED_VERSION="3.10"

if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$PYTHON_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
    print_error "Python $PYTHON_VERSION is installed, but Python $REQUIRED_VERSION or higher is required."
    exit 1
fi

# Check if the package is installed by trying to import the server module
if ! python3 -c "import sys; sys.path.insert(0, '$PROJECT_ROOT/src'); import server" 2>/dev/null; then
    print_warning "MCP Build package is not properly installed."
    echo ""
    echo "Running setup..."

    # Check if we're in the project directory with setup.sh
    if [ -f "$PROJECT_ROOT/setup.sh" ]; then
        cd "$PROJECT_ROOT"
        bash setup.sh
    else
        # Fallback: try to install directly
        if [ -f "$PROJECT_ROOT/pyproject.toml" ]; then
            cd "$PROJECT_ROOT"
            pip3 install -e .
        else
            print_error "Could not find setup.sh or pyproject.toml. Please run setup manually."
            exit 1
        fi
    fi

    echo ""
    print_success "Setup complete!"
    echo ""
fi

# Try to use the installed entry point first, fall back to running the module directly
if command -v mcp-build &> /dev/null && [ "$(command -v mcp-build)" != "$SCRIPT_DIR/mcp-build" ]; then
    # The installed mcp-build command is available (and it's not this script)
    exec mcp-build "$@"
else
    # Run the Python module directly
    cd "$PROJECT_ROOT"
    exec python3 -m server "$@"
fi
