#!/bin/bash
# MCP Build Service Deployment Configuration
# https://github.com/jbroll/deploy.sh

# =============================================================================
# Global Configuration
# =============================================================================

export APP_NAME="mcp-build"
export DOMAIN_NAME="symon.rkroll.com"
export REMOTE_HOST="symon.rkroll.com"
export REMOTE_USER="john"

# =============================================================================
# Deployment Modules
# =============================================================================

export DEPLOY_TYPES="letsencrypt apache binary_service"
export LETSENCRYPT_EMAIL="john@rkroll.com"

# =============================================================================
# Apache Reverse Proxy Configuration
# =============================================================================

export APACHE_MODE="proxy"

# Apache listens on port 3344 for HTTPS (port 443 is used by router)
export APACHE_HTTPS_PORT="3344"
export APACHE_HTTP_PORT="80"

# mcp-build service runs on localhost:3345
export APACHE_PROXY_BACKEND_HOST="127.0.0.1"
export APACHE_PROXY_BACKEND_PORT="3345"

# Proxy all traffic to mcp-build service
# Format: "incoming_path:backend_port:backend_path"
export APACHE_PROXY_RULES="/:3345:/"

# =============================================================================
# Binary Service Configuration
# =============================================================================

export BINARY_SERVICE_USER="john"
export BINARY_SERVICE_GROUP="john"
export BINARY_SERVICE_BINARY_NAME="mcp-build"

export BINARY_SERVICE_WORK_DIR="/data/john/src"
export BINARY_SERVICE_APPEND_APP_NAME="false"

export BINARY_SERVICE_RESTART_POLICY="always"
export BINARY_SERVICE_RESTART_SEC="10"

export BINARY_SERVICE_PROTECT_HOME="false"
export BINARY_SERVICE_PROTECT_SYSTEM="false"

# =============================================================================
# MCP Build Service CLI Arguments
# =============================================================================
# Using CLI arguments instead of environment variables for clarity
#
# Session Key Management:
# - First startup: Service generates a new key and saves to ~/.mcp-build-key
# - Subsequent startups: Service reads existing key from ~/.mcp-build-key
# - Key persists across service restarts (stored in file)
#
# To rotate the key:
#   ssh john@symon.rkroll.com 'rm ~/.mcp-build-key'
#   ssh john@symon.rkroll.com 'sudo systemctl restart mcp-build'
#   ssh john@symon.rkroll.com 'cat ~/.mcp-build-key'  # Get new key
#
# Or manually edit the key file:
#   ssh john@symon.rkroll.com 'echo "your-new-key" > ~/.mcp-build-key && chmod 600 ~/.mcp-build-key'

export BINARY_SERVICE_BINARY_ARGS="--transport http --host 127.0.0.1 --port 3345 --key-file ~/.mcp-build-key"

# =============================================================================
# Session Key Retrieval
# =============================================================================
# After deployment, retrieve the session key with:
#   ssh john@symon.rkroll.com cat ~/.mcp-build-key
#
# Configure in Claude Desktop:
#   {
#     "mcpServers": {
#       "mcp-build": {
#         "url": "https://symon.rkroll.com/sse?key=SESSION_KEY"
#       }
#     }
#   }
# =============================================================================

