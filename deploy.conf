#!/bin/bash
# MCP Build Service Deployment Configuration
# https://github.com/jbroll/deploy.sh

# =============================================================================
# Global Configuration
# =============================================================================

export APP_NAME="mcp-build"
export DOMAIN_NAME="symon.rkroll.com"
export REMOTE_HOST="symon.rkroll.com"
export REMOTE_USER="john"

# =============================================================================
# Deployment Modules
# =============================================================================

export DEPLOY_TYPES="letsencrypt apache binary_service"
export LETSENCRYPT_EMAIL="john@rkroll.com"

# =============================================================================
# Apache Reverse Proxy Configuration
# =============================================================================

export APACHE_MODE="proxy"
export APACHE_PROXY_BACKEND_HOST="127.0.0.1"
export APACHE_PROXY_BACKEND_PORT="3344"

# =============================================================================
# Binary Service Configuration
# =============================================================================

# Run as personal user account to access repositories in /home/john/src/*
export BINARY_SERVICE_USER="john"
export BINARY_SERVICE_GROUP="john"
export BINARY_SERVICE_BINARY_NAME="mcp-build"

# Working directory - service runs in /home/john/src to discover repos
# Disable APP_NAME appending for full control over working directory
export BINARY_SERVICE_WORK_DIR="/home/john/src"
export BINARY_SERVICE_APPEND_APP_NAME="false"

# Systemd service configuration
export BINARY_SERVICE_RESTART_POLICY="always"
export BINARY_SERVICE_RESTART_SEC="10"

# Security: Allow access to home directory for repository operations
export BINARY_SERVICE_PROTECT_HOME="false"

# =============================================================================
# MCP Build Service CLI Arguments
# =============================================================================
# Using CLI arguments instead of environment variables for clarity
#
# Session Key Management:
# - First startup: Service generates a new key and saves to ~/.mcp-build-key
# - Subsequent startups: Service reads existing key from ~/.mcp-build-key
# - Key persists across service restarts (stored in file)
#
# To rotate the key:
#   ssh john@symon.rkroll.com 'rm ~/.mcp-build-key'
#   ssh john@symon.rkroll.com 'sudo systemctl restart mcp-build'
#   ssh john@symon.rkroll.com 'cat ~/.mcp-build-key'  # Get new key
#
# Or manually edit the key file:
#   ssh john@symon.rkroll.com 'echo "your-new-key" > ~/.mcp-build-key && chmod 600 ~/.mcp-build-key'

export BINARY_SERVICE_BINARY_ARGS="--transport http --host 127.0.0.1 --port 3344 --key-file ~/.mcp-build-key"

# =============================================================================
# Session Key Retrieval
# =============================================================================
# After deployment, retrieve the session key with:
#   ssh john@symon.rkroll.com cat ~/.mcp-build-key
#
# Configure in Claude Desktop:
#   {
#     "mcpServers": {
#       "mcp-build": {
#         "url": "https://symon.rkroll.com/sse?key=SESSION_KEY"
#       }
#     }
#   }
# =============================================================================

